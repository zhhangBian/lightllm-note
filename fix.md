# MinerU2.5 Tokenæ•°é‡ä¸åŒ¹é…é—®é¢˜æ·±åº¦åˆ†æ

## ç›®å½•
1. [Qwen2-VLæ¨¡å‹æ¶æ„æ¦‚è¿°](#1-qwen2-vlæ¨¡å‹æ¶æ„æ¦‚è¿°)
2. [Spatial MergeæŠ€æœ¯è¯¦è§£](#2-spatial-mergeæŠ€æœ¯è¯¦è§£)
3. [åŸå§‹ä»£ç çš„é—®é¢˜åˆ†æ](#3-åŸå§‹ä»£ç çš„é—®é¢˜åˆ†æ)
4. [ä¿®å¤æ–¹æ¡ˆçš„ç†è®ºåŸºç¡€](#4-ä¿®å¤æ–¹æ¡ˆçš„ç†è®ºåŸºç¡€)
5. [å®Œæ•´æ•°æ®æµå¯¹æ¯”](#5-å®Œæ•´æ•°æ®æµå¯¹æ¯”)
6. [ä¸ºä»€ä¹ˆåŸæ¥çš„ä¸è¡Œ](#6-ä¸ºä»€ä¹ˆåŸæ¥çš„ä¸è¡Œ)
7. [ä¸ºä»€ä¹ˆç°åœ¨çš„å¯ä»¥](#7-ä¸ºä»€ä¹ˆç°åœ¨çš„å¯ä»¥)

---

## 1. Qwen2-VLæ¨¡å‹æ¶æ„æ¦‚è¿°

### 1.1 æ•´ä½“æ¶æ„

Qwen2-VLæ˜¯ä¸€ä¸ªè§†è§‰-è¯­è¨€å¤šæ¨¡æ€å¤§æ¨¡å‹ï¼Œä¸»è¦åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Qwen2-VL æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  [å›¾åƒè¾“å…¥] â”€â”€â†’ [Vision Encoder] â”€â”€â†’ [æŠ•å½±å±‚]          â”‚
â”‚                      â†“                    â†“             â”‚
â”‚                è§†è§‰ç‰¹å¾æå–          ç‰¹å¾å¯¹é½            â”‚
â”‚                                          â†“             â”‚
â”‚  [æ–‡æœ¬Token] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ [åˆå¹¶] â”€â”€â†’ [LLM]   â”‚
â”‚                                          â†“             â”‚
â”‚                                      ç»Ÿä¸€è¡¨ç¤º            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç»„ä»¶**ï¼š
- **Vision Encoder**: æå–å›¾åƒç‰¹å¾ï¼ŒåŸºäºVision Transformer (ViT)
- **Spatial Merge**: å‡å°‘è§†è§‰tokenæ•°é‡ï¼Œæé«˜æ•ˆç‡
- **æŠ•å½±å±‚**: å°†è§†è§‰ç‰¹å¾æ˜ å°„åˆ°LLMçš„è¯­ä¹‰ç©ºé—´
- **LLMä¸»å¹²**: å¤„ç†è§†è§‰-æ–‡æœ¬è”åˆè¡¨ç¤º

### 1.2 Vision Encoderçš„å¤„ç†æµç¨‹

```
åŸå§‹å›¾åƒ (HÃ—WÃ—3)
    â†“
[1] Smart Resize â”€â”€â†’ è°ƒæ•´åˆ°åˆé€‚å°ºå¯¸ (H'Ã—W')
    â†“
[2] Patch Embedding â”€â”€â†’ åˆ‡åˆ†æˆpatches (Nä¸ª14Ã—14çš„å—)
    â†“
[3] Vision Transformer â”€â”€â†’ æå–ç‰¹å¾ (Nä¸ªç‰¹å¾å‘é‡)
    â†“
[4] Spatial Merge â”€â”€â†’ åˆå¹¶ç›¸é‚»patches (N/4ä¸ªç‰¹å¾)
    â†“
[5] æŠ•å½±åˆ°LLMç©ºé—´ â”€â”€â†’ æœ€ç»ˆçš„è§†è§‰token
```

**å…³é”®å‚æ•°**ï¼š
- `patch_size = 14`: æ¯ä¸ªpatchæ˜¯14Ã—14åƒç´ 
- `merge_size = 2`: 2Ã—2çš„patchesåˆå¹¶æˆ1ä¸ª
- `temporal_patch_size = 2`: æ—¶é—´ç»´åº¦çš„å¤„ç†ï¼ˆç”¨äºè§†é¢‘ï¼‰

---

## 2. Spatial MergeæŠ€æœ¯è¯¦è§£

### 2.1 è®¾è®¡åŠ¨æœº

**é—®é¢˜**ï¼šé«˜åˆ†è¾¨ç‡å›¾åƒä¼šäº§ç”Ÿå¤§é‡çš„visual tokens
- ä¾‹å¦‚ï¼š1008Ã—1120çš„å›¾åƒ â†’ 72Ã—80 = 5760ä¸ªpatches
- æ¯ä¸ªpatchéœ€è¦åœ¨LLMä¸­å ç”¨ä¸€ä¸ªtokenä½ç½®
- è¿‡å¤šçš„visual tokensä¼šï¼š
  - æ¶ˆè€—å¤§é‡è®¡ç®—èµ„æº
  - å ç”¨è¿‡å¤šä¸Šä¸‹æ–‡é•¿åº¦
  - é™ä½æ¨ç†é€Ÿåº¦

**è§£å†³æ–¹æ¡ˆ**ï¼šSpatial Merge
- å°†ç›¸é‚»çš„2Ã—2ä¸ªpatchesåˆå¹¶æˆ1ä¸ªæ›´å¤§çš„patch
- Tokenæ•°é‡å‡å°‘åˆ°åŸæ¥çš„1/4
- 5760ä¸ªpatches â†’ 1440ä¸ªmerged patches

### 2.2 Mergeæ“ä½œçš„æ•°å­¦åŸç†

#### åŸå§‹Patchesæ’åˆ—
```
å‡è®¾æœ‰4Ã—4çš„gridï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰ï¼š

ä½ç½®ç¼–å·ï¼š
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”
â”‚ 0  â”‚ 1  â”‚ 2  â”‚ 3  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ 4  â”‚ 5  â”‚ 6  â”‚ 7  â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ 8  â”‚ 9  â”‚ 10 â”‚ 11 â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”¤
â”‚ 12 â”‚ 13 â”‚ 14 â”‚ 15 â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜

æ€»å…±ï¼š16ä¸ªpatches
```

#### Mergeåçš„ç»“æ„
```
2Ã—2 Mergeï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block0 â”‚ Block1  â”‚
â”‚ (0,1,   â”‚ (2,3,   â”‚
â”‚  4,5)   â”‚  6,7)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Block2  â”‚ Block3  â”‚
â”‚ (8,9,   â”‚ (10,11, â”‚
â”‚  12,13) â”‚  14,15) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ€»å…±ï¼š4ä¸ªmerged blocks
```

#### æ•°æ®é‡æ’è¿‡ç¨‹

**æ­¥éª¤1ï¼šReshape**
```python
# åŸå§‹: (16,) çš„ä¸€ç»´åºåˆ—
# Reshapeæˆ: (2, 2, 2, 2)
#  ç»´åº¦å«ä¹‰: (h_blocks, merge_h, w_blocks, merge_w)

åŸå§‹æ’åˆ—: [0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15]

Reshapeå:
[[[[ 0,  1],  # h_blocks=0, merge_h=0, w_blocks=0
   [ 2,  3]], # h_blocks=0, merge_h=0, w_blocks=1
  
  [[ 4,  5],  # h_blocks=0, merge_h=1, w_blocks=0
   [ 6,  7]]], # h_blocks=0, merge_h=1, w_blocks=1
 
 [[[ 8,  9],  # h_blocks=1, merge_h=0, w_blocks=0
   [10, 11]], # h_blocks=1, merge_h=0, w_blocks=1
  
  [[12, 13],  # h_blocks=1, merge_h=1, w_blocks=0
   [14, 15]]]] # h_blocks=1, merge_h=1, w_blocks=1
```

**æ­¥éª¤2ï¼šTranspose**
```python
# transpose(0, 2, 1, 3)
# é‡æ’ç»´åº¦é¡ºåº: (h_blocks, w_blocks, merge_h, merge_w)

ç»“æœ:
[[[ 0,  1],   # Block 0: h_blocks=0, w_blocks=0
  [ 4,  5]],
 
 [[ 2,  3],   # Block 1: h_blocks=0, w_blocks=1
  [ 6,  7]],
 
 [[ 8,  9],   # Block 2: h_blocks=1, w_blocks=0
  [12, 13]],
 
 [[10, 11],   # Block 3: h_blocks=1, w_blocks=1
  [14, 15]]]
```

**æ­¥éª¤3ï¼šFlatten**
```python
# æ¯ä¸ªblockå†…éƒ¨flatten
# (4, 4) â†’ 4ä¸ªblocksï¼Œæ¯ä¸ªåŒ…å«4ä¸ªå…ƒç´ 

Block 0: [0, 1, 4, 5]
Block 1: [2, 3, 6, 7]
Block 2: [8, 9, 12, 13]
Block 3: [10, 11, 14, 15]
```

### 2.3 åœ¨Qwen2-VLä¸­çš„å®ç°

#### å®é™…æ•°æ®ç»´åº¦

å¯¹äºresizedåçš„1008Ã—1120å›¾åƒï¼š
```python
åŸå§‹å°ºå¯¸: 1008Ã—1120
gridå°ºå¯¸: 72Ã—80  # (1008/14, 1120/14)
patchesæ•°: 5760  # 72Ã—80

ç»è¿‡mergeå:
merged_grid: 36Ã—40  # (72/2, 80/2)
merged_patches: 1440  # 36Ã—40
```

#### å…³é”®çš„Reshapeå’ŒTransposeæ“ä½œ

```python
# vision_process.py çš„å…³é”®ä»£ç 

# è¾“å…¥patches shape: (1, 2, 3, 1008, 1120)
#  ç»´åº¦: (grid_t, temporal_patch_size, channel, height, width)

# ç¬¬144-154è¡Œ: Reshape
patches = patches.reshape(
    grid_t,                    # 1
    temporal_patch_size,       # 2
    channel,                   # 3
    grid_h // merge_size,      # 36  â† mergeåçš„é«˜åº¦blocks
    merge_size,                # 2
    patch_size,                # 14
    grid_w // merge_size,      # 40  â† mergeåçš„å®½åº¦blocks
    merge_size,                # 2
    patch_size                 # 14
)
# ç»“æœshape: (1, 2, 3, 36, 2, 14, 40, 2, 14)

# ç¬¬155è¡Œ: Transpose
patches = patches.transpose(0, 3, 6, 4, 7, 2, 1, 5, 8)
# ç»“æœshape: (1, 36, 40, 2, 2, 3, 2, 14, 14)
#  ç»´åº¦å«ä¹‰: (grid_t, h_blocks, w_blocks, merge_h, merge_w, 
#            channel, temporal, patch_h, patch_w)
```

---

## 3. åŸå§‹ä»£ç çš„é—®é¢˜åˆ†æ

### 3.1 é—®é¢˜1ï¼šé”™è¯¯çš„Reshapeé€»è¾‘

#### é”™è¯¯ä»£ç 
```python
# vision_process.py ç¬¬156-158è¡Œï¼ˆåŸå§‹é”™è¯¯ç‰ˆæœ¬ï¼‰
flatten_patches = patches.reshape(
    grid_t * grid_h * grid_w,        # 1 Ã— 72 Ã— 80 = 5760 âŒ
    channel * temporal_patch_size * patch_size * patch_size  # 3Ã—2Ã—14Ã—14 = 1176
)
```

#### é—®é¢˜åˆ†æ

**transposeåçš„å®é™…shape**ï¼š
```
(1, 36, 40, 2, 2, 3, 2, 14, 14)
å‰3ç»´: (grid_t, h_blocks, w_blocks) = (1, 36, 40)
å‰3ç»´ä¹˜ç§¯: 1 Ã— 36 Ã— 40 = 1440 â† è¿™æ˜¯mergeåçš„å®é™…tokenæ•°
```

**é”™è¯¯reshapeçš„ç»´åº¦**ï¼š
```
ç›®æ ‡shape: (5760, 1176)
ä½†transposeåçš„ç»´åº¦æ˜¯: (1, 36, 40, ...)

é—®é¢˜ï¼š
- reshapeçš„ç¬¬ä¸€ç»´ä½¿ç”¨çš„æ˜¯ grid_h Ã— grid_w = 5760
- ä½†transposeåå‰3ç»´çš„ä¹˜ç§¯æ˜¯ 36 Ã— 40 = 1440
- 5760 â‰  1440

è™½ç„¶æ€»å…ƒç´ æ•°ç›¸åŒï¼ˆéƒ½æ˜¯6,796,800ï¼‰ï¼Œreshapeå¯ä»¥æˆåŠŸ
ä½†è¿™ä¼šç ´åç©ºé—´ç»“æ„ï¼
```

**ç©ºé—´ç»“æ„è¢«ç ´åçš„ç¤ºä¾‹**ï¼š

å‡è®¾transposeåçš„æ•°æ®é€»è¾‘æ’åˆ—æ˜¯ï¼š
```
[Block(0,0), Block(0,1), ..., Block(0,39),
 Block(1,0), Block(1,1), ..., Block(1,39),
 ...
 Block(35,0), Block(35,1), ..., Block(35,39)]
 
æ€»å…±1440ä¸ªblocksï¼Œæ¯ä¸ªblockåŒ…å«2Ã—2Ã—3Ã—2Ã—14Ã—14=4704ä¸ªå…ƒç´ 
```

é”™è¯¯çš„reshape(5760, 1176)ä¼šå°†æ•°æ®é‡æ–°åˆ†å‰²æˆï¼š
```
5760ä¸ª"ä¼ªpatches"ï¼Œæ¯ä¸ª1176ä¸ªå…ƒç´ 

è¿™æ‰“ä¹±äº†åŸæœ‰çš„mergeç»“æ„ï¼
ä¾‹å¦‚ï¼š
- ç¬¬1ä¸ª"ä¼ªpatch"å¯èƒ½åŒ…å«Block(0,0)çš„éƒ¨åˆ†æ•°æ®
- ç¬¬2ä¸ª"ä¼ªpatch"åŒ…å«Block(0,0)çš„å¦ä¸€éƒ¨åˆ†å’ŒBlock(0,1)çš„éƒ¨åˆ†
- ç©ºé—´é‚»è¿‘æ€§è¢«å®Œå…¨ç ´å
```

### 3.2 é—®é¢˜2ï¼šåŒé‡Resizeå¯¼è‡´çš„å°ºå¯¸ä¸ä¸€è‡´

#### æ•°æ®æµåˆ†æ

**get_image_token_lengthçš„è®¡ç®—è·¯å¾„**ï¼š
```python
# httpserver/manager.py ç¬¬159è¡Œ
token_num = tokenizer.get_image_token_length(img)

# model.py ç¬¬52-59è¡Œ
def get_image_token_length(self, img: ImageItem):
    width, height = img.image_w, img.image_h  # åŸå§‹å›¾åƒå°ºå¯¸
    resized_height, resized_width = smart_resize(
        height=height, 
        width=width, 
        min_pixels=self.min_pixel,      # 3136
        max_pixels=self.max_pixel        # 1,605,632 (MinerUé…ç½®)
    )
    grid_h = resized_height // self.patch_size
    grid_w = resized_width // self.patch_size
    token_num = (grid_h * grid_w) // (self.merge_size ** 2)
    return token_num
```

**vision encoderçš„å¤„ç†è·¯å¾„**ï¼š
```python
# qwen2_visual.py ç¬¬314-316è¡Œï¼ˆåŸå§‹é”™è¯¯ç‰ˆæœ¬ï¼‰
image_data = Image.open(BytesIO(image_data))
image_data = resize_image(image_data)  # ç¬¬ä¸€æ¬¡resize âŒ
pixel_values, grid_thw = self.processor.preprocess(image_data)  # ç¬¬äºŒæ¬¡resize âŒ

# resize_image å‡½æ•°ï¼ˆvision_process.py ç¬¬55-69è¡Œï¼‰
def resize_image(image_file, size_factor=IMAGE_FACTOR):
    resized_height, resized_width = smart_resize(
        height, width,
        factor=size_factor,
        min_pixels=MIN_PIXELS,          # 3136
        max_pixels=MAX_PIXELS           # 12,845,056 (ç¡¬ç¼–ç ï¼) âŒ
    )
    image = image.resize((resized_width, resized_height))
    return image

# processor.preprocess å†…éƒ¨ï¼ˆvision_process.py ç¬¬115-121è¡Œï¼‰
resized_height, resized_width = smart_resize(
    height, width,
    factor=self.patch_size * self.merge_size,
    min_pixels=self.min_pixels,         # 3136
    max_pixels=self.max_pixels          # 1,605,632 (é…ç½®æ–‡ä»¶)
)
```

#### é—®é¢˜åœºæ™¯å¤ç°

å‡è®¾è¾“å…¥å›¾åƒï¼š2000Ã—2200

**get_image_token_lengthçš„è®¡ç®—**ï¼š
```
smart_resize(2000, 2200, max_pixels=1,605,632)
â†’ éœ€è¦ç¼©å°ï¼Œå› ä¸º 2000Ã—2200 = 4,400,000 > 1,605,632
â†’ beta = sqrt(4,400,000 / 1,605,632) = 1.655
â†’ resized: floor(2000/1.655/28)Ã—28 Ã— floor(2200/1.655/28)Ã—28
â†’ resized: 1204Ã—1316
â†’ grid: 86Ã—94
â†’ token_num = (86Ã—94) // 4 = 2021
```

**vision encoderå®é™…å¤„ç†**ï¼š
```
ç¬¬ä¸€æ¬¡resize_image:
  smart_resize(2000, 2200, max_pixels=12,845,056)
  â†’ ä¸éœ€è¦ç¼©å°ï¼Œå› ä¸º 4,400,000 < 12,845,056
  â†’ åªè°ƒæ•´åˆ°28çš„å€æ•°
  â†’ resized: 2016Ã—2212

ç¬¬äºŒæ¬¡preprocesså†…éƒ¨:
  smart_resize(2016, 2212, max_pixels=1,605,632)
  â†’ éœ€è¦ç¼©å°ï¼Œå› ä¸º 2016Ã—2212 = 4,459,392 > 1,605,632
  â†’ beta = sqrt(4,459,392 / 1,605,632) = 1.666
  â†’ resized: 1176Ã—1288
  â†’ grid: 84Ã—92
  â†’ å®é™…tokens = (84Ã—92) // 4 = 1932
```

**ç»“æœ**ï¼š
```
get_image_token_lengthè®¡ç®—: 2021
å®é™…vision encoderå¤„ç†:    1932
ä¸åŒ¹é…ï¼ğŸ’¥
```

### 3.3 é—®é¢˜3ï¼šgrid_thwçš„è¯­ä¹‰æ··æ·†

#### grid_thwçš„åŒé‡ç”¨é€”

```python
# ç”¨é€”1ï¼šä¼ é€’ç»™rot_pos_embç”Ÿæˆä½ç½®ç¼–ç 
def rot_pos_emb(self, grid_thw):
    for _, h, w in grid_thw:
        pos_shape = (h // s, s, w // s, s)  # éœ€è¦mergeå‰çš„hå’Œw
        hpos_ids = torch.arange(h).unsqueeze(1).expand(-1, w)
        # ...

# ç”¨é€”2ï¼šå¯èƒ½è¢«ç”¨æ¥éªŒè¯æˆ–è®¡ç®—å…¶ä»–å†…å®¹
```

#### é”™è¯¯ä¿®æ”¹å¯¼è‡´çš„é—®é¢˜

å½“æˆ‘ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶ï¼Œé”™è¯¯åœ°å°†grid_thwæ”¹ä¸ºmergeåçš„å€¼ï¼š
```python
# é”™è¯¯çš„ä¿®æ”¹
image_grid_thw = (grid_t, grid_h // merge_size, grid_w // merge_size)
# ä¾‹å¦‚: (1, 36, 40)
```

**å¯¼è‡´çš„é”™è¯¯**ï¼š
```python
# rot_pos_emb å‡½æ•°ä¸­
h, w = 36, 40  # mergeåçš„å€¼
pos_shape = (h // 2, 2, w // 2, 2) = (18, 2, 20, 2)

hpos_ids = torch.arange(36).unsqueeze(1).expand(-1, 40)
# shape: (36, 40) = 1440ä¸ªå…ƒç´ 

hpos_ids.reshape(pos_shape)
# éœ€è¦: 18Ã—2Ã—20Ã—2 = 1440 âœ“ å…ƒç´ æ•°é‡åŒ¹é…

ä½†è¯­ä¹‰é”™è¯¯ï¼
```

**ä¸ºä»€ä¹ˆè¯­ä¹‰é”™è¯¯ï¼Ÿ**

```
rot_pos_embçš„è®¾è®¡æ„å›¾ï¼š
1. ä¸ºåŸå§‹çš„72Ã—80 gridç”Ÿæˆä½ç½®ç¼–ç 
2. ç„¶åæŒ‰ç…§mergeçš„æ–¹å¼é‡æ’è¿™äº›ä½ç½®ç¼–ç 

å¦‚æœä¼ å…¥mergeåçš„36Ã—40ï¼š
- åªèƒ½ç”Ÿæˆ36Ã—40ä¸ªä½ç½®ç¼–ç 
- ä¸¢å¤±äº†åŸå§‹patchçº§åˆ«çš„ä½ç½®ä¿¡æ¯
- æ— æ³•æ­£ç¡®è¡¨ç¤º2Ã—2 mergeçš„ç©ºé—´å…³ç³»
```

---

## 4. ä¿®å¤æ–¹æ¡ˆçš„ç†è®ºåŸºç¡€

### 4.1 æ­£ç¡®çš„Reshapeé€»è¾‘

#### ç†è®ºæ¨å¯¼

**transposeåçš„shapeåˆ†æ**ï¼š
```
(1, 36, 40, 2, 2, 3, 2, 14, 14)

ç»´åº¦åˆ†ç»„ï¼š
- ç©ºé—´ç»´åº¦ (å‰3ç»´): (1, 36, 40) â†’ 1440ä¸ªspatial tokens
- ç‰¹å¾ç»´åº¦ (å6ç»´): (2, 2, 3, 2, 14, 14) â†’ æ¯ä¸ªtokençš„ç‰¹å¾

æ­£ç¡®çš„flattenåº”è¯¥æ˜¯ï¼š
ç¬¬ä¸€ç»´ = 1 Ã— 36 Ã— 40 = 1440
ç¬¬äºŒç»´ = 2 Ã— 2 Ã— 3 Ã— 2 Ã— 14 Ã— 14 = 4704
```

#### æ­£ç¡®ä»£ç 
```python
flatten_patches = patches.reshape(
    -1,  # è®©numpy/torchè‡ªåŠ¨è®¡ç®— = 1440
    channel * temporal_patch_size * merge_size * merge_size * patch_size * patch_size
    # 3 Ã— 2 Ã— 2 Ã— 2 Ã— 14 Ã— 14 = 4704
)
```

**ä¸ºä»€ä¹ˆä½¿ç”¨-1ï¼Ÿ**
- ç¡®ä¿ä¸transposeåçš„ç»´åº¦ç»“æ„ä¸€è‡´
- é¿å…ç¡¬ç¼–ç å¯¼è‡´çš„ç»´åº¦ä¸åŒ¹é…
- è‡ªåŠ¨é€‚é…ä¸åŒçš„å›¾åƒå°ºå¯¸

### 4.2 æ¶ˆé™¤åŒé‡Resize

#### è®¾è®¡åŸåˆ™

**Single Source of Truthï¼ˆå•ä¸€æ•°æ®æºï¼‰**ï¼š
- å›¾åƒåªåº”è¯¥è¢«resizeä¸€æ¬¡
- get_image_token_lengthå’Œvision encoderåº”è¯¥çœ‹åˆ°ç›¸åŒçš„å›¾åƒå°ºå¯¸
- ä½¿ç”¨ç›¸åŒçš„å‚æ•°ï¼ˆmin_pixels, max_pixelsï¼‰

#### ä¿®å¤æ–¹æ¡ˆ
```python
# qwen2_visual.py
image_data = Image.open(BytesIO(image_data))
# ç§»é™¤è¿™ä¸€è¡Œ: image_data = resize_image(image_data)  âŒ
pixel_values, grid_thw = self.processor.preprocess(image_data)
```

**ä¸ºä»€ä¹ˆå¯ä»¥ç§»é™¤resize_imageï¼Ÿ**
- preprocesså†…éƒ¨å·²ç»åŒ…å«resizeé€»è¾‘
- preprocessä½¿ç”¨çš„æ˜¯é…ç½®æ–‡ä»¶çš„å‚æ•°ï¼ˆæ­£ç¡®çš„max_pixelsï¼‰
- é¿å…äº†åŒé‡resizeå¯¼è‡´çš„å°ºå¯¸å˜åŒ–

### 4.3 grid_thwçš„æ­£ç¡®è¯­ä¹‰

#### è®¾è®¡å†³ç­–

**åˆ†ç¦»æ¦‚å¿µ**ï¼š
```python
pixel_values.shape[0]  # å®é™…çš„tokenæ•°é‡ï¼ˆmergeåï¼‰
grid_thw              # åŸå§‹gridå°ºå¯¸ï¼ˆmergeå‰ï¼‰

ä¸¤è€…å…³ç³»:
pixel_values.shape[0] = (grid_thw[1] Ã— grid_thw[2]) // (merge_sizeÂ²)
```

**ä¸ºä»€ä¹ˆgrid_thwå¿…é¡»æ˜¯mergeå‰çš„å€¼ï¼Ÿ**

```python
# rot_pos_embçš„è®¾è®¡
def rot_pos_emb(self, grid_thw):
    for _, h, w in grid_thw:  # h=72, w=80 (mergeå‰)
        # ç”Ÿæˆ72Ã—80çš„å®Œæ•´ä½ç½®çŸ©é˜µ
        pos_shape = (h//2, 2, w//2, 2)  # (36, 2, 40, 2)
        hpos_ids = torch.arange(h)  # 0åˆ°71
        
        # reshapeä¼šè‡ªåŠ¨æŒ‰mergeæ–¹å¼é‡æ’
        # (72, 80) â†’ (36, 2, 40, 2)
        # æ¯ä¸ª(2,2)çš„blockå…±äº«ç›¸ä¼¼çš„ä½ç½®ç¼–ç 
```

**ä½ç½®ç¼–ç çš„mergeæ“ä½œç¤ºæ„**ï¼š
```
åŸå§‹ä½ç½®çŸ©é˜µ (72Ã—80):
[ 0  1  2  3 ... 79]
[ 0  1  2  3 ... 79]
...
[71 71 71 71 ... 71]

reshapeæˆ (36, 2, 40, 2) åï¼š
Block[0,0] åŒ…å«ä½ç½®:
  h: [0, 0]  w: [0, 1]
  h: [1, 1]  w: [0, 1]

è¿™ä¿æŒäº†2Ã—2 mergeå†…éƒ¨çš„ä½ç½®å…³ç³»
```

---

## 5. å®Œæ•´æ•°æ®æµå¯¹æ¯”

### 5.1 åŸå§‹é”™è¯¯æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ï¼ˆå›¾åƒ2000Ã—2200ï¼‰
    â†“
httpserver/manager.py:
  â””â”€ get_image_token_length(img)
      â””â”€ smart_resize(2000, 2200, max_pixels=1,605,632)
      â””â”€ resized: 1204Ã—1316
      â””â”€ token_num = (86Ã—94) // 4 = 2021 âœ“
      â””â”€ å­˜å…¥cache
    â†“
visual server:
  â””â”€ resize_image(image)  â† ç¬¬ä¸€æ¬¡resize
      â””â”€ smart_resize(2000, 2200, max_pixels=12,845,056)
      â””â”€ resized: 2016Ã—2212
    â†“
  â””â”€ preprocess(image)  â† ç¬¬äºŒæ¬¡resize
      â””â”€ smart_resize(2016, 2212, max_pixels=1,605,632)
      â””â”€ resized: 1176Ã—1288
      â””â”€ grid: 84Ã—92
      
      âŒ é”™è¯¯çš„reshape:
      patches.reshape(84Ã—92=7728, 1176)
      
      å®é™…transposeåçš„ç»“æ„:
      (1, 42, 46, 2, 2, 3, 2, 14, 14)
      å‰3ç»´ = 42Ã—46 = 1932
      
      å¼ºåˆ¶reshapeæˆ(7728, 1176)ç ´åäº†ç©ºé—´ç»“æ„
      
  â””â”€ cur_num = 7728 // 4 = 1932 âŒ
  â””â”€ forward â†’ embedding (1932, 896)
  â””â”€ data_size = 1932 Ã— 896 = 1,731,072
    â†“
pre_layer_infer:
  â””â”€ token_num (from cache) = 2021
  â””â”€ reshape(2021, -1)
  â””â”€ 1,731,072 / 2021 = 856.4... âŒ ä¸æ˜¯æ•´æ•°
  â””â”€ ğŸ’¥ RuntimeError!
```

### 5.2 ä¿®å¤åçš„æ­£ç¡®æµç¨‹

```
ç”¨æˆ·è¯·æ±‚ï¼ˆå›¾åƒ2000Ã—2200ï¼‰
    â†“
httpserver/manager.py:
  â””â”€ get_image_token_length(img)
      â””â”€ smart_resize(2000, 2200, max_pixels=1,605,632)
      â””â”€ resized: 1204Ã—1316
      â””â”€ grid: 86Ã—94
      â””â”€ token_num = (86Ã—94) // 4 = 2021 âœ“
      â””â”€ å­˜å…¥cache
    â†“
visual server:
  â””â”€ âŒ ç§»é™¤äº†resize_imageè°ƒç”¨
  â””â”€ preprocess(image)  â† å”¯ä¸€çš„resize
      â””â”€ smart_resize(2000, 2200, max_pixels=1,605,632)
      â””â”€ resized: 1204Ã—1316 âœ“ ä¸get_image_token_lengthä¸€è‡´ï¼
      â””â”€ grid: 86Ã—94
      
      âœ“ æ­£ç¡®çš„reshape:
      patches.reshape(-1, 3Ã—2Ã—4Ã—14Ã—14=4704)
      è‡ªåŠ¨è®¡ç®—ç¬¬ä¸€ç»´ = 1Ã—43Ã—47 = 2021
      
      (1, 86, 94, ...) â†’ transpose â†’ (1, 43, 47, 2, 2, ...)
      å‰3ç»´ = 43Ã—47 = 2021 âœ“
      
  â””â”€ cur_num = 2021 âœ“ ç›´æ¥ä½¿ç”¨shape[0]
  â””â”€ forward â†’ embedding (2021, 896)
  â””â”€ data_size = 2021 Ã— 896 = 1,810,816
    â†“
pre_layer_infer:
  â””â”€ token_num (from cache) = 2021
  â””â”€ reshape(2021, -1)
  â””â”€ 1,810,816 / 2021 = 896 âœ“ å®Œç¾åŒ¹é…ï¼
  â””â”€ âœ“ æˆåŠŸæ‰§è¡Œ
```

---

## 6. ä¸ºä»€ä¹ˆåŸæ¥çš„ä¸è¡Œ

### 6.1 æ¨¡å‹å±‚é¢çš„æ ¹æœ¬çŸ›ç›¾

#### çŸ›ç›¾1ï¼šMergeè¯­ä¹‰çš„ç ´å

**Spatial Mergeçš„æœ¬è´¨**ï¼š
- å°†ç©ºé—´ä¸Šç›¸é‚»çš„2Ã—2ä¸ªpatchesåˆå¹¶æˆ1ä¸ªtoken
- è¿™ä¸ªè¿‡ç¨‹å¿…é¡»ä¿æŒç©ºé—´ç»“æ„çš„è¿ç»­æ€§
- Mergeåçš„tokenåº”è¯¥ç¼–ç äº†åŸæ¥4ä¸ªpatchesçš„ä¿¡æ¯

**åŸå§‹ä»£ç çš„é—®é¢˜**ï¼š
```python
# é”™è¯¯çš„reshape
patches.reshape(grid_h * grid_w, ...)

è¿™ç›¸å½“äºï¼š
1. å…ˆæŒ‰åŸå§‹gridæ–¹å¼åˆ†å‰²æ•°æ®ï¼ˆ72Ã—80 = 5760ä»½ï¼‰
2. æ¯ä»½1176ä¸ªå…ƒç´ 

ä½†å®é™…æ•°æ®å·²ç»è¢«transposeé‡æ’æˆï¼š
1. æŒ‰mergeåçš„gridç»„ç»‡ï¼ˆ36Ã—40 = 1440ç»„ï¼‰
2. æ¯ç»„4704ä¸ªå…ƒç´ 

å¼ºåˆ¶reshapeä¼šï¼š
- ç¬¬1ä¸ª"token"å¯èƒ½åŒ…å«Block[0,0]çš„å‰1176ä¸ªå…ƒç´ 
- ç¬¬2ä¸ª"token"åŒ…å«Block[0,0]çš„å‰©ä½™å…ƒç´  + Block[0,1]çš„éƒ¨åˆ†å…ƒç´ 
- ç©ºé—´é‚»è¿‘æ€§è¢«å®Œå…¨æ‰“ä¹±
```

**å¯¹æ¨¡å‹çš„å½±å“**ï¼š
```
Vision TransformeræœŸæœ›ï¼š
- æ¯ä¸ªtokenä»£è¡¨ä¸€ä¸ªç©ºé—´åŒºåŸŸçš„å®Œæ•´ä¿¡æ¯
- Self-attentionåœ¨è¿™äº›tokenä¹‹é—´å»ºç«‹å…³ç³»

å®é™…å¾—åˆ°çš„ï¼š
- Tokenè¾¹ç•Œéšæ„åˆ‡å‰²ï¼ŒåŒ…å«ä¸å®Œæ•´çš„åŒºåŸŸä¿¡æ¯
- åŒä¸€ä¸ªmerge blockçš„ä¿¡æ¯è¢«åˆ†æ•£åˆ°å¤šä¸ª"token"
- Self-attentionæ— æ³•æ­£ç¡®å»ºæ¨¡ç©ºé—´å…³ç³»
- ä½ç½®ç¼–ç ä¸å®é™…tokenå†…å®¹ä¸å¯¹åº”
```

#### çŸ›ç›¾2ï¼šä½ç½®ç¼–ç çš„å¤±é…

**Vision Transformerçš„ä½ç½®ç¼–ç **ï¼š
```python
# rot_pos_embç”Ÿæˆçš„ä½ç½®ç¼–ç 
# å¯¹äºgrid(72, 80)ï¼Œç”Ÿæˆ5760ä¸ªä½ç½®

ä½ç½®ç¼–ç çŸ©é˜µ:
pos[0,0]   pos[0,1]   ... pos[0,79]
pos[1,0]   pos[1,1]   ... pos[1,79]
...
pos[71,0]  pos[71,1]  ... pos[71,79]

ç»è¿‡mergeåçš„é‡æ’:
merged_pos[0] = merge(pos[0:2, 0:2])   # åŒ…å«4ä¸ªåŸå§‹ä½ç½®
merged_pos[1] = merge(pos[0:2, 2:4])
...
```

**åŸå§‹ä»£ç å¯¼è‡´çš„é—®é¢˜**ï¼š
```
è™½ç„¶ä½ç½®ç¼–ç æ˜¯å¯¹çš„ï¼Œä½†tokenå†…å®¹æ˜¯é”™çš„ï¼š
- ä½ç½®ç¼–ç è¯´"è¿™æ˜¯ä½ç½®(0,0)çš„merge block"
- ä½†å®é™…tokenå†…å®¹å¯èƒ½åŒ…å«ä½ç½®(0,0)å’Œ(0,1)çš„éƒ¨åˆ†æ··åˆæ•°æ®
- ä½ç½®ç¼–ç ä¸å†…å®¹ä¸åŒ¹é…
```

#### çŸ›ç›¾3ï¼šTokenæ•°é‡çš„ä¸ä¸€è‡´

**ä¸‰ä¸ªåœ°æ–¹è®¡ç®—tokenæ•°é‡**ï¼š
```
1. get_image_token_length:
   token_num = (grid_h Ã— grid_w) // 4
   ç”¨é€”: åˆ†é…cacheç©ºé—´ï¼Œè®¡ç®—åºåˆ—é•¿åº¦

2. vision encoderçš„cur_num:
   cur_num = pixel_values.shape[0] // 4  (åŸå§‹ä»£ç )
   ç”¨é€”: è®°å½•å®é™…ç”Ÿæˆçš„embeddingæ•°é‡

3. å®é™…çš„embedding shape[0]:
   çœŸå®çš„tokenæ•°é‡
```

**ä¸ä¸€è‡´çš„åœºæ™¯**ï¼š

åœºæ™¯Aï¼šåŒé‡resizeï¼Œä¸åŒå°ºå¯¸
```
get_image_token_length: resizeåˆ°1204Ã—1316 â†’ 2021 tokens
vision encoder: resizeåˆ°1176Ã—1288 â†’ 1932 tokens
ä¸åŒ¹é…ï¼
```

åœºæ™¯Bï¼šé”™è¯¯çš„reshape
```
transposeå: (1, 43, 47, ...) â†’ 2021ä¸ªçœŸå®tokens
é”™è¯¯reshape: (1, 86, 94) â†’ å£°ç§°8084ä¸ªtokens
cur_num = 8084 // 4 = 2021 (ç¢°å·§æ­£ç¡®)

ä½†å†…éƒ¨æ•°æ®ç»“æ„å·²ç»é”™ä¹±
```

### 6.2 æ•°å€¼å±‚é¢çš„ä¸å¯è¡Œæ€§

#### ç»´åº¦è®¡ç®—çš„ä¸å…¼å®¹

```python
# ç»™å®š: æ•°æ®å¤§å° = 1,787,520 bytes
# token_num = 2016 (æ¥è‡ªget_image_token_length)

reshape(2016, -1)éœ€è¦:
1,787,520 / 2016 = 886.666...  âŒ ä¸æ˜¯æ•´æ•°

è¿™è¡¨æ˜:
- æ•°æ®å¤§å°å¯¹åº”çš„å®é™…tokenæ•° â‰  2016
- å®é™…tokenæ•° = 1,787,520 / 896 = 1995ï¼ˆå‡è®¾hidden=896ï¼‰
  æˆ– = 1,787,520 / 1176 = 1520ï¼ˆå¦‚æœæ˜¯mergeå‰çš„ç»“æ„ï¼‰
```

#### å†…å­˜å¸ƒå±€çš„ä¸è¿ç»­

```python
é”™è¯¯çš„reshape(5760, 1176)äº§ç”Ÿçš„å†…å­˜è§†å›¾:

åŸå§‹æ•°æ®ï¼ˆæŒ‰merge blockç»„ç»‡ï¼‰:
[Block0_data(4704), Block1_data(4704), ...]

é”™è¯¯reshapeåçš„è§†å›¾:
[æ··åˆæ•°æ®1(1176), æ··åˆæ•°æ®2(1176), ...]

é—®é¢˜:
- æ¯ä¸ª"token"çš„1176ä¸ªå…ƒç´ æ¥è‡ªä¸åŒçš„blocks
- å†…å­˜è®¿é—®æ¨¡å¼ä¸è¿ç»­
- Cache missç‡é«˜
- æ€§èƒ½ä¸‹é™
```

---

## 7. ä¸ºä»€ä¹ˆç°åœ¨çš„å¯ä»¥

### 7.1 æ¨¡å‹å±‚é¢çš„æ­£ç¡®æ€§

#### æ­£ç¡®æ€§1ï¼šä¿æŒMergeçš„è¯­ä¹‰

**æ­£ç¡®çš„æ•°æ®ç»„ç»‡**ï¼š
```python
# transposeå: (1, 43, 47, 2, 2, 3, 2, 14, 14)
# reshapeæˆ: (2021, 4704)

æ¯ä¸ªtoken (4704ç»´):
- åŒ…å«å®Œæ•´çš„2Ã—2 merge block
- 2Ã—2 Ã— 3 Ã— 2 Ã— 14Ã—14 = 4704
  â”œâ”€ 2Ã—2: merge_sizeÂ²ï¼Œ4ä¸ªåŸå§‹patches
  â”œâ”€ 3: RGBé€šé“
  â”œâ”€ 2: temporalç»´åº¦
  â””â”€ 14Ã—14: æ¯ä¸ªpatchçš„åƒç´ 

ç©ºé—´ç»“æ„:
Token[0] â† Block(0,0) çš„å®Œæ•´ä¿¡æ¯
Token[1] â† Block(0,1) çš„å®Œæ•´ä¿¡æ¯
...
Token[2020] â† Block(42,46) çš„å®Œæ•´ä¿¡æ¯
```

**å¯¹Vision Transformerçš„å½±å“**ï¼š
```
Self-attentionç°åœ¨å¯ä»¥æ­£ç¡®å·¥ä½œ:
1. æ¯ä¸ªtokenæ˜¯ä¸€ä¸ªå®Œæ•´çš„ç©ºé—´åŒºåŸŸ
2. Tokenä¹‹é—´çš„å…³ç³»åæ˜ çœŸå®çš„ç©ºé—´å…³ç³»
3. ä½ç½®ç¼–ç ä¸tokenå†…å®¹å®Œç¾å¯¹åº”
4. Mergeæ“ä½œçš„æ•ˆæœå¾—ä»¥ä¿ç•™
```

#### æ­£ç¡®æ€§2ï¼šä½ç½®ç¼–ç çš„ä¸€è‡´æ€§

**æ­£ç¡®çš„grid_thwä½¿ç”¨**ï¼š
```python
grid_thw = (1, 86, 94)  # mergeå‰çš„grid

rot_pos_embå¤„ç†:
1. ç”Ÿæˆ86Ã—94=8084ä¸ªåŸå§‹ä½ç½®ç¼–ç 
2. reshapeæˆ(43, 2, 47, 2)ç»“æ„
3. è‡ªåŠ¨æŒ‰mergeæ–¹å¼ç»„ç»‡
4. æ¯ä¸ªmerge blockåŒ…å«æ­£ç¡®çš„4ä¸ªä½ç½®ç¼–ç 
```

**ä½ç½®ç¼–ç ä¸å†…å®¹çš„å¯¹åº”**ï¼š
```
Token[0]:
  å†…å®¹: Block(0,0) çš„mergeæ•°æ®
  ä½ç½®: merge(pos[0,0], pos[0,1], pos[1,0], pos[1,1])
  âœ“ å®Œç¾å¯¹åº”

Token[47]:
  å†…å®¹: Block(0,47) çš„mergeæ•°æ®  
  ä½ç½®: merge(pos[0,94], pos[0,95], pos[1,94], pos[1,95])
  âœ“ å®Œç¾å¯¹åº”
```

#### æ­£ç¡®æ€§3ï¼šTokenæ•°é‡çš„å…¨å±€ä¸€è‡´

**ç»Ÿä¸€çš„è®¡ç®—è·¯å¾„**ï¼š
```
åŸå§‹å›¾åƒ: 2000Ã—2200
    â†“
å”¯ä¸€çš„resize (max_pixels=1,605,632):
    resized: 1204Ã—1316
    grid: 86Ã—94
    â†“
å…¨å±€ä¸€è‡´çš„tokenæ•°:
    get_image_token_length: (86Ã—94) // 4 = 2021 âœ“
    pixel_values.shape[0]: 2021 âœ“
    cur_num: 2021 âœ“
    embedding.shape[0]: 2021 âœ“
    cacheåˆ†é…: 2021 slots âœ“
```

### 7.2 æ•°å€¼å±‚é¢çš„è‡ªæ´½æ€§

#### ç»´åº¦å®Œç¾åŒ¹é…

```python
å®é™…æ•°æ®æµ:
1. preprocessè¾“å‡º: pixel_values (2021, 4704)
2. vision encoderå¤„ç†: 2021ä¸ªtokens
3. æ¯ä¸ªtokenç»è¿‡transformer: (2021, 896)
4. æ€»æ•°æ®å¤§å°: 2021 Ã— 896 = 1,810,816

cacheä¸­çš„æœŸæœ›:
token_num = 2021
éœ€è¦çš„hidden_size = 896

reshapeéªŒè¯:
1,810,816 / 2021 = 896.0 âœ“ å®Œç¾æ•´é™¤
reshape(2021, 896) âœ“ æˆåŠŸ
```

#### å†…å­˜å¸ƒå±€çš„è¿ç»­æ€§

**ä¼˜åŒ–çš„å†…å­˜è®¿é—®**ï¼š
```python
æ­£ç¡®çš„reshapeå:
[Token0(4704), Token1(4704), ..., Token2020(4704)]

ç‰¹ç‚¹:
- æ¯ä¸ªtokenæ˜¯è¿ç»­çš„4704ä¸ªå…ƒç´ 
- Tokené—´é¡ºåºå¯¹åº”ç©ºé—´é¡ºåº
- Cacheå‹å¥½çš„è®¿é—®æ¨¡å¼
- å‘é‡åŒ–æ“ä½œé«˜æ•ˆ
```

### 7.3 é²æ£’æ€§å’Œé€šç”¨æ€§

#### é€‚åº”ä¸åŒå›¾åƒå°ºå¯¸

```python
ä½¿ç”¨ -1 è‡ªåŠ¨æ¨å¯¼:
flatten_patches = patches.reshape(-1, 4704)

ä¼˜åŠ¿:
- è‡ªåŠ¨é€‚é…ä»»æ„å›¾åƒå°ºå¯¸
- ä¸ä¾èµ–ç¡¬ç¼–ç çš„gridå€¼
- å‡å°‘è¾¹ç•Œæƒ…å†µçš„bug
```

**æµ‹è¯•ä¸åŒå°ºå¯¸**ï¼š
```
å›¾åƒ1: 800Ã—600
  â†’ resize: 840Ã—616
  â†’ grid: 60Ã—44
  â†’ tokens: (60Ã—44)//4 = 660
  â†’ reshape(-1, 4704) â†’ (660, 4704) âœ“

å›¾åƒ2: 2400Ã—1800
  â†’ resize: 1260Ã—952
  â†’ grid: 90Ã—68
  â†’ tokens: (90Ã—68)//4 = 1530
  â†’ reshape(-1, 4704) â†’ (1530, 4704) âœ“

å›¾åƒ3: 1000Ã—1000
  â†’ resize: 1008Ã—1008
  â†’ grid: 72Ã—72
  â†’ tokens: (72Ã—72)//4 = 1296
  â†’ reshape(-1, 4704) â†’ (1296, 4704) âœ“
```

#### æ¶ˆé™¤äº†ç«æ€æ¡ä»¶

**åŸå§‹ä»£ç çš„æ½œåœ¨ç«æ€**ï¼š
```
ä¸åŒçš„å›¾åƒå¯èƒ½è§¦å‘ä¸åŒçš„resizeè·¯å¾„:
- å°å›¾åƒ: resize_imageä¸ç¼©å° â†’ preprocessç¼©å°
- å¤§å›¾åƒ: resize_imageç¼©å° â†’ preprocesså†ç¼©å°
- ä¸´ç•Œå›¾åƒ: ä¸¤æ¬¡resizeäº§ç”Ÿæ„å¤–çš„å°ºå¯¸å˜åŒ–

ç»“æœï¼štokenæ•°é‡çš„ä¸å¯é¢„æµ‹æ€§
```

**ä¿®å¤å**ï¼š
```
æ‰€æœ‰å›¾åƒç»Ÿä¸€å¤„ç†:
- åªç»è¿‡ä¸€æ¬¡resizeï¼ˆåœ¨preprocessä¸­ï¼‰
- ä½¿ç”¨ä¸€è‡´çš„å‚æ•°ï¼ˆé…ç½®æ–‡ä»¶çš„max_pixelsï¼‰
- å¯é¢„æµ‹çš„tokenæ•°é‡
- ç¨³å®šçš„æ€§èƒ½è¡¨ç°
```

---

## æ€»ç»“

### æ ¸å¿ƒé—®é¢˜
1. **Reshapeç»´åº¦é”™è¯¯**ï¼šä½¿ç”¨mergeå‰çš„gridå€¼ç ´åäº†ç©ºé—´ç»“æ„
2. **åŒé‡Resize**ï¼šä¸ä¸€è‡´çš„å‚æ•°å¯¼è‡´tokenæ•°é‡è®¡ç®—é”™è¯¯
3. **grid_thwè¯­ä¹‰æ··æ·†**ï¼šä½ç½®ç¼–ç éœ€è¦mergeå‰çš„å€¼ï¼Œä½†æ•°æ®æ˜¯mergeåçš„

### ä¿®å¤è¦ç‚¹
1. **æ­£ç¡®çš„Reshape**ï¼šä½¿ç”¨`-1`è‡ªåŠ¨æ¨å¯¼ï¼ŒåŒ…å«`merge_sizeÂ²`
2. **å•ä¸€Resize**ï¼šç§»é™¤`resize_image`ï¼Œåªåœ¨`preprocess`ä¸­resize
3. **è¯­ä¹‰åˆ†ç¦»**ï¼š`pixel_values.shape[0]`æ˜¯å®é™…tokenæ•°ï¼Œ`grid_thw`æ˜¯ä½ç½®ç¼–ç ç”¨çš„grid

### ä¸ºä»€ä¹ˆä¿®å¤æœ‰æ•ˆ
- **æ•°æ®ç»“æ„ä¸€è‡´æ€§**ï¼šæ¯ä¸ªtokenåŒ…å«å®Œæ•´çš„merge blockä¿¡æ¯
- **æ•°å€¼è®¡ç®—æ­£ç¡®æ€§**ï¼štokenæ•°é‡åœ¨å„ç¯èŠ‚ä¿æŒä¸€è‡´
- **æ¨¡å‹è¯­ä¹‰æ­£ç¡®æ€§**ï¼šä½ç½®ç¼–ç ä¸tokenå†…å®¹æ­£ç¡®å¯¹åº”
- **é²æ£’æ€§å’Œé€šç”¨æ€§**ï¼šé€‚åº”ä»»æ„å›¾åƒå°ºå¯¸ï¼Œæ— ç«æ€æ¡ä»¶

è¿™ä¸ªä¿®å¤ä¸ä»…è§£å†³äº†è¡¨é¢çš„æ•°å€¼é”™è¯¯ï¼Œæ›´é‡è¦çš„æ˜¯æ¢å¤äº†Qwen2-VLæ¨¡å‹è®¾è®¡çš„åŸå§‹è¯­ä¹‰ï¼Œç¡®ä¿äº†Spatial MergeæŠ€æœ¯çš„æ­£ç¡®å®ç°ã€‚
